name: Publish NPM Package

# This workflow publishes the RIPP CLI npm package to the npm registry.
# It can be triggered automatically by release-please or manually with safety controls.
#
# Automatic trigger:
# - When a GitHub Release is published with a tag matching "ripp-cli-v*"
# - This happens when release-please PRs are merged
#
# Prerequisites:
# - An npm access token with publish rights must be configured as NPM_TOKEN secret
#
# To set up the NPM_TOKEN:
# 1. Log in to npmjs.com
# 2. Go to Access Tokens â†’ Generate New Token â†’ Choose "Granular Access Token"
# 3. Set permissions: "Read and write" for packages
# 4. Enable "Bypass 2FA requirement" (required for CI/CD automation)
# 5. Add it as a repository secret named NPM_TOKEN
#
# IMPORTANT: The token MUST have "Bypass 2FA" enabled for automated publishing to work.
# Standard Automation tokens may fail with E403 if 2FA is enabled on your npm account.
#
# Manual Usage:
# - Set dry_run=true (default) to test without actually publishing
# - Set dry_run=false to publish for real
# - Set tag to "latest" (default), "next", or "beta"
# - Override package_path if needed (default: tools/ripp-cli)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package_path:
        description: 'Path to the package to publish (default: tools/ripp-cli)'
        required: false
        type: string
        default: 'tools/ripp-cli'
      tag:
        description: 'NPM dist-tag for this publish'
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
        default: latest
      dry_run:
        description: 'Dry run only (test without publishing)'
        required: false
        type: boolean
        default: true

# Prevent concurrent publishes
concurrency:
  group: npm-publish-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  publish:
    name: Publish to NPM Registry
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.metadata.outputs.name }}
      package_version: ${{ steps.metadata.outputs.version }}
      published: ${{ steps.publish_status.outputs.published }}
    
    # Only run if:
    # - Auto-publish is enabled (for release events), OR
    # - Manual workflow_dispatch
    # - For release events, only run for ripp-cli tags
    if: |
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'ripp-cli-v') && vars.ENABLE_AUTO_PUBLISH == 'true') ||
      github.event_name == 'workflow_dispatch'
    
    defaults:
      run:
        working-directory: ${{ github.event.inputs.package_path || 'tools/ripp-cli' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: ${{ github.event.inputs.package_path || 'tools/ripp-cli' }}/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get package metadata
        id: metadata
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          PACKAGE_SCOPE=$(echo "$PACKAGE_NAME" | grep -oP '^@[^/]+' || echo "")
          
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "scope=$PACKAGE_SCOPE" >> $GITHUB_OUTPUT
          
          echo "Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          
          # Check if package.json has required fields
          HAS_BIN=$(node -p "!!require('./package.json').bin")
          echo "has_bin=$HAS_BIN" >> $GITHUB_OUTPUT
      
      - name: Verify working tree is clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Working tree is dirty. Please commit or stash changes before publishing."
            git status
            exit 1
          fi
          echo "âœ… Working tree is clean"
      
      - name: Run lint
        run: |
          if npm run lint --if-present; then
            echo "âœ… Lint passed"
          else
            echo "âš ï¸ No lint script found or lint failed"
          fi
      
      - name: Run tests
        run: |
          if npm test --if-present; then
            echo "âœ… Tests passed"
          else
            echo "âš ï¸ No test script found or tests failed"
          fi
      
      - name: Run build
        run: |
          if npm run build --if-present; then
            echo "âœ… Build completed"
          else
            echo "â„¹ï¸ No build script found (may not be needed)"
          fi
      
      - name: Verify npm authentication
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::NPM_TOKEN secret is not configured. Cannot proceed."
            exit 1
          fi
          
          echo "Verifying npm authentication..."
          if npm whoami; then
            echo "âœ… Successfully authenticated with npm registry"
          else
            echo "::error::npm authentication failed. Check that NPM_TOKEN is valid and has required permissions."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Check published version
        id: version_check
        run: |
          PACKAGE_NAME="${{ steps.metadata.outputs.name }}"
          CURRENT_VERSION="${{ steps.metadata.outputs.version }}"
          
          # Get latest published version from npm
          PUBLISHED_VERSION=$(npm view "$PACKAGE_NAME" version 2>/dev/null || echo "none")
          
          echo "published_version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$PUBLISHED_VERSION" = "none" ]; then
            echo "â„¹ï¸ Package not yet published to npm"
            echo "version_status=new" >> $GITHUB_OUTPUT
            
            # For new packages, check if the name exists at all (might be owned by someone else)
            if npm view "$PACKAGE_NAME" 2>/dev/null; then
              echo "::warning::Package name '$PACKAGE_NAME' exists in registry but has no versions."
              echo "This might indicate the package is reserved or owned by another account."
              echo "If publish fails with E403, you may need to choose a different package name."
            fi
          elif [ "$PUBLISHED_VERSION" = "$CURRENT_VERSION" ]; then
            echo "::error::Version $CURRENT_VERSION is already published. Please bump the version in package.json"
            exit 1
          else
            echo "âœ… Version check passed: $PUBLISHED_VERSION â†’ $CURRENT_VERSION"
            echo "version_status=bump" >> $GITHUB_OUTPUT
          fi
      
      - name: Verify package contents
        run: |
          echo "# Package Contents Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm pack --dry-run 2>&1 | tee /tmp/pack-output.txt
          cat /tmp/pack-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Dry run NPM publish validation
        run: |
          echo "# ðŸ§ª Dry Run Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running \`npm publish --dry-run\` to validate package before publishing..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run dry-run and capture output
          npm publish --dry-run --tag ${{ github.event.inputs.tag || 'latest' }} 2>&1 | tee /tmp/dry-run-output.txt
          
          # Check for sensitive files in the output
          if grep -iE "(\.env|\.git|\.npmrc|secret|token|password|private)" /tmp/dry-run-output.txt; then
            echo "âš ï¸ Warning: Potential sensitive files detected in package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verify package structure
          echo "âœ… Dry run validation passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package is ready for publishing**" >> $GITHUB_STEP_SUMMARY
          
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Dry run publish (manual trigger only)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "# ðŸ§ª Dry Run Mode (Manual)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Manual dry-run mode enabled - will NOT publish to NPM." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To publish for real, re-run with \`dry_run=false\`**" >> $GITHUB_STEP_SUMMARY
      
      - name: Publish to NPM
        id: publish_status
        # Only publish if:
        # - This is a release event (auto-publish), OR
        # - Manual workflow with dry_run=false
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
        run: |
          # Determine access flag (public for unscoped packages)
          ACCESS_FLAG=""
          if [ -z "${{ steps.metadata.outputs.scope }}" ]; then
            ACCESS_FLAG="--access public"
          fi
          
          echo "Publishing to npm registry..."
          npm publish $ACCESS_FLAG --tag ${{ github.event.inputs.tag || 'latest' }}
          
          echo "âœ… Successfully published to npm!"
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Job summary
        if: always()
        run: |
          # Determine if this was a dry run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN="true"
          else
            DRY_RUN="false"
          fi
          
          TAG="${{ github.event.inputs.tag || 'latest' }}"
          
          # Determine if package was actually published
          if [ "${{ github.event_name }}" == "release" ] || ([ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" == "false" ]); then
            PUBLISH_STATUS="true"
          else
            PUBLISH_STATUS="false"
          fi
          
          if [ "$PUBLISH_STATUS" == "true" ]; then
            echo "# âœ… Successfully Published to NPM! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ðŸ“¦ Dry Run Complete (Not Published)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Name:** \`${{ steps.metadata.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.metadata.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Dist Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          
          VERSION_STATUS="${{ steps.version_check.outputs.version_status }}"
          if [ "$VERSION_STATUS" == "new" ]; then
            echo "**Status:** First publish (new package)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Previous Version:** \`${{ steps.version_check.outputs.published_version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PUBLISH_STATUS" == "true" ]; then
            echo "**NPM URL:** https://www.npmjs.com/package/${{ steps.metadata.outputs.name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The package should be available via \`npm install ${{ steps.metadata.outputs.name }}\` within a few minutes." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next Step:** Re-run this workflow with \`dry_run=false\` to publish for real." >> $GITHUB_STEP_SUMMARY
          fi
  
  smoke-tests:
    name: Post-Publish Smoke Tests
    runs-on: ubuntu-latest
    needs: publish
    # Only run smoke tests if package was actually published
    if: needs.publish.outputs.published == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Wait for NPM registry propagation
        run: |
          echo "â³ Waiting 30 seconds for NPM registry to propagate..."
          sleep 30
      
      - name: Install published package globally
        run: |
          echo "# ðŸ§ª Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Installing package: ${{ needs.publish.outputs.package_name }}@${{ needs.publish.outputs.package_version }}" >> $GITHUB_STEP_SUMMARY
          
          # Try to install the package, retry up to 3 times if it fails
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if npm install -g ${{ needs.publish.outputs.package_name }}@${{ needs.publish.outputs.package_version }}; then
              echo "âœ… Package installed successfully" >> $GITHUB_STEP_SUMMARY
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "::error::Failed to install package after $max_attempts attempts"
                echo "âŒ Failed to install package after $max_attempts attempts" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
              echo "Installation failed, waiting 30s before retry..."
              sleep 30
              attempt=$((attempt + 1))
            fi
          done
      
      - name: Verify CLI help command
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## CLI Help Command Test" >> $GITHUB_STEP_SUMMARY
          
          if ripp --help > /tmp/help-output.txt 2>&1; then
            echo "âœ… CLI help command executed successfully" >> $GITHUB_STEP_SUMMARY
            
            # Verify help output contains expected content
            if grep -q "validate" /tmp/help-output.txt && grep -q "lint" /tmp/help-output.txt; then
              echo "âœ… Help output contains expected commands" >> $GITHUB_STEP_SUMMARY
            else
              echo "::error::Help output missing expected commands"
              echo "âŒ Help output missing expected commands" >> $GITHUB_STEP_SUMMARY
              cat /tmp/help-output.txt
              exit 1
            fi
          else
            echo "::error::CLI help command failed"
            echo "âŒ CLI help command failed" >> $GITHUB_STEP_SUMMARY
            cat /tmp/help-output.txt
            exit 1
          fi
      
      - name: Run validation against example files
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Example File Validation Tests" >> $GITHUB_STEP_SUMMARY
          
          # Find example RIPP files
          example_files=$(find examples -name "*.ripp.yaml" -o -name "*.ripp.json" 2>/dev/null | head -3)
          
          if [ -z "$example_files" ]; then
            echo "âš ï¸ No example files found to test" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          test_passed=true
          for file in $example_files; do
            echo "Testing: $file"
            if ripp validate "$file" > /tmp/validate-output.txt 2>&1; then
              echo "âœ… Validated: \`$file\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "::error::Validation failed for $file"
              echo "âŒ Validation failed: \`$file\`" >> $GITHUB_STEP_SUMMARY
              cat /tmp/validate-output.txt
              test_passed=false
            fi
          done
          
          if [ "$test_passed" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ One or more validation tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Smoke tests summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… All Smoke Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The published package is working correctly and ready for use." >> $GITHUB_STEP_SUMMARY
  
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [publish, smoke-tests]
    # Only run if smoke tests failed
    if: always() && needs.publish.outputs.published == 'true' && needs.smoke-tests.result == 'failure'
    
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Unpublish broken package
        run: |
          echo "# ðŸš¨ Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Smoke tests failed for ${{ needs.publish.outputs.package_name }}@${{ needs.publish.outputs.package_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Unpublish the specific version
          echo "Unpublishing broken package version..."
          if npm unpublish ${{ needs.publish.outputs.package_name }}@${{ needs.publish.outputs.package_version }} --force; then
            echo "âœ… Successfully unpublished broken version" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Failed to unpublish - manual intervention required" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Failed to unpublish package automatically"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Create incident issue
        uses: actions/github-script@v8
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ NPM Publish Rollback: ${{ needs.publish.outputs.package_name }}@${{ needs.publish.outputs.package_version }}`,
              body: `## Automated Rollback Incident
            
            **Package:** \`${{ needs.publish.outputs.package_name }}\`
            **Version:** \`${{ needs.publish.outputs.package_version }}\`
            **Trigger:** Smoke tests failed after publishing
            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            ### What Happened
            
            The package was successfully published to NPM but failed post-publish smoke tests. An automatic rollback was triggered to unpublish the broken version and prevent users from installing it.
            
            ### Next Steps
            
            1. Review the [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) to identify the failure
            2. Fix the issue in the code
            3. Bump the version number
            4. Retry the publish workflow
            
            ### Smoke Test Failures
            
            Check the workflow logs for detailed error messages from the smoke tests.
            `,
              labels: ['bug', 'publish-failure', 'automated-incident']
            });
            
            console.log(`Created incident issue #${issue.data.number}`);
      
      - name: Rollback summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Rollback Actions Taken:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Unpublished broken package version" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Created incident issue in repository" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Notified about the rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual review required before retrying publish.**" >> $GITHUB_STEP_SUMMARY
