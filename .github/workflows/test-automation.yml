name: Test Release Automation

# This workflow provides comprehensive testing of the full release automation pipeline
# including release-please, VSIX builds, NPM publishing, and artifact generation.
#
# Purpose:
# - Verify that release-please creates proper release PRs with version bumps
# - Test VS Code extension builds and VSIX package creation
# - Test NPM CLI package builds and publishing readiness
# - Validate artifact generation with correct versions
# - Ensure version consistency across all package.json files and tags
# - Test dry-run publishing workflows for both NPM and VS Code Marketplace
# - Provide detailed logging and test reports
#
# Safety Features:
# - Runs only on workflow_dispatch (manual trigger)
# - Uses dry-run mode by default to prevent accidental publishing
# - Requires explicit confirmation for any destructive operations
# - Validates all pre-conditions before proceeding
#
# Usage:
# 1. Go to Actions tab â†’ Test Release Automation â†’ Run workflow
# 2. Select test scenario (default: full-pipeline-dry-run)
# 3. Review the test report in the workflow summary

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        type: choice
        options:
          - full-pipeline-dry-run
          - release-please-only
          - vsix-build-only
          - npm-package-only
          - version-consistency-check
        default: full-pipeline-dry-run
      target_package:
        description: 'Target package to test (for package-specific tests)'
        required: false
        type: choice
        options:
          - both
          - vscode-extension
          - ripp-cli
        default: both
      verbose_logging:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: read

jobs:
  # Job 1: Test Release-Please Configuration
  test-release-please:
    name: Test Release-Please Configuration
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_scenario == 'full-pipeline-dry-run' ||
      github.event.inputs.test_scenario == 'release-please-only'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Validate release-please config files
        run: |
          echo "# ðŸ§ª Release-Please Configuration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if config files exist
          if [ ! -f "release-please-config.json" ]; then
            echo "âŒ release-please-config.json not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… release-please-config.json exists" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -f ".release-please-manifest.json" ]; then
            echo "âŒ .release-please-manifest.json not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… .release-please-manifest.json exists" >> $GITHUB_STEP_SUMMARY
          
          # Validate JSON syntax
          if jq empty release-please-config.json 2>/dev/null; then
            echo "âœ… release-please-config.json is valid JSON" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ release-please-config.json has invalid JSON syntax" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if jq empty .release-please-manifest.json 2>/dev/null; then
            echo "âœ… .release-please-manifest.json is valid JSON" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ .release-please-manifest.json has invalid JSON syntax" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Verify package configurations
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Package Configurations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check VS Code extension config
          VSCODE_CONFIG=$(jq -r '.packages."tools/vscode-extension"' release-please-config.json)
          if [ "$VSCODE_CONFIG" != "null" ]; then
            echo "âœ… VS Code extension configured in release-please" >> $GITHUB_STEP_SUMMARY
            
            VSCODE_TAG_FORMAT=$(jq -r '.packages."tools/vscode-extension"."include-component-in-tag"' release-please-config.json)
            echo "  - Tag format: include-component=$VSCODE_TAG_FORMAT" >> $GITHUB_STEP_SUMMARY
            
            VSCODE_VERSION=$(jq -r '."tools/vscode-extension"' .release-please-manifest.json)
            echo "  - Current version: $VSCODE_VERSION" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ VS Code extension not configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check ripp-cli config
          CLI_CONFIG=$(jq -r '.packages."tools/ripp-cli"' release-please-config.json)
          if [ "$CLI_CONFIG" != "null" ]; then
            echo "âœ… ripp-cli configured in release-please" >> $GITHUB_STEP_SUMMARY
            
            CLI_TAG_FORMAT=$(jq -r '.packages."tools/ripp-cli"."include-component-in-tag"' release-please-config.json)
            echo "  - Tag format: include-component=$CLI_TAG_FORMAT" >> $GITHUB_STEP_SUMMARY
            
            CLI_VERSION=$(jq -r '."tools/ripp-cli"' .release-please-manifest.json)
            echo "  - Current version: $CLI_VERSION" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ripp-cli not configured" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Verify workflow file
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Release-Please Workflow Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -f ".github/workflows/release-please.yml" ]; then
            echo "âŒ release-please.yml workflow not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… release-please.yml workflow exists" >> $GITHUB_STEP_SUMMARY
          
          # Check for required configuration
          if grep -q "googleapis/release-please-action@v4" .github/workflows/release-please.yml; then
            echo "âœ… Uses release-please-action v4" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Not using release-please-action v4" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "config-file: release-please-config.json" .github/workflows/release-please.yml; then
            echo "âœ… Config file reference found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Config file reference not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "manifest-file: .release-please-manifest.json" .github/workflows/release-please.yml; then
            echo "âœ… Manifest file reference found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Manifest file reference not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Test VS Code Extension Build
  test-vsix-build:
    name: Test VSIX Build
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_scenario == 'full-pipeline-dry-run' ||
      github.event.inputs.test_scenario == 'vsix-build-only' ||
      (github.event.inputs.test_scenario == 'version-consistency-check' && 
       (github.event.inputs.target_package == 'both' || github.event.inputs.target_package == 'vscode-extension'))
    
    defaults:
      run:
        working-directory: tools/vscode-extension
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tools/vscode-extension/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          PUBLISHER=$(node -p "require('./package.json').publisher")
          NAME=$(node -p "require('./package.json').name")
          
          echo "publisher=$PUBLISHER" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          
          echo "# ðŸ§ª VS Code Extension Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Extension:** $PUBLISHER.$NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "âœ… Version format is Marketplace-compliant: $VERSION" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Version format is not Marketplace-compliant: $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "Expected format: X.Y.Z or X.Y.Z.W (numeric only)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Compile TypeScript
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm run compile
          echo "âœ… TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
      
      - name: Run lint
        run: |
          npm run lint
          echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
      
      - name: Create output directory
        run: mkdir -p dist
      
      - name: Package VSIX
        run: |
          npx @vscode/vsce package --no-dependencies --out dist/
          echo "âœ… VSIX packaging successful" >> $GITHUB_STEP_SUMMARY
      
      - name: Verify VSIX package
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## VSIX Package Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VSIX_COUNT=$(ls -1 dist/*.vsix 2>/dev/null | wc -l)
          if [ "$VSIX_COUNT" -eq 0 ]; then
            echo "âŒ No VSIX file was produced" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          VSIX_FILE=$(ls -1 dist/*.vsix | head -1)
          VSIX_BASENAME=$(basename "$VSIX_FILE")
          VSIX_SIZE=$(du -h "$VSIX_FILE" | cut -f1)
          
          echo "âœ… VSIX package created: \`$VSIX_BASENAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $VSIX_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # Verify filename format
          if echo "$VSIX_BASENAME" | grep -qE '\-[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?\.vsix$'; then
            echo "âœ… VSIX filename is Marketplace-compliant" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ VSIX filename may not be Marketplace-compliant: $VSIX_BASENAME" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Verify package contents
          if unzip -t "$VSIX_FILE" > /dev/null 2>&1; then
            echo "âœ… VSIX structure is valid (can be unzipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ VSIX structure is invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check for manifest
          if unzip -l "$VSIX_FILE" | grep -q "extension/package.json"; then
            echo "âœ… Extension manifest found in VSIX" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Extension manifest not found in VSIX" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Test dry-run publish
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Dry-Run Publish Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Note: This would normally require VSCE_PAT, but we're just testing the workflow structure
          echo "âœ… Dry-run publish validation: VSIX package is ready for publishing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Actual marketplace publishing requires \`VSCE_PAT\` secret" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v6
        with:
          name: vsix-test-build-${{ steps.version.outputs.version }}
          path: tools/vscode-extension/dist/*.vsix
          retention-days: 7

  # Job 3: Test NPM Package Build
  test-npm-package:
    name: Test NPM Package Build
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_scenario == 'full-pipeline-dry-run' ||
      github.event.inputs.test_scenario == 'npm-package-only' ||
      (github.event.inputs.test_scenario == 'version-consistency-check' && 
       (github.event.inputs.target_package == 'both' || github.event.inputs.target_package == 'ripp-cli'))
    
    defaults:
      run:
        working-directory: tools/ripp-cli
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tools/ripp-cli/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get package metadata
        id: metadata
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          HAS_BIN=$(node -p "!!require('./package.json').bin")
          
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "has_bin=$HAS_BIN" >> $GITHUB_OUTPUT
          
          echo "# ðŸ§ª NPM Package Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** $PACKAGE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $PACKAGE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Has binary:** $HAS_BIN" >> $GITHUB_STEP_SUMMARY
      
      - name: Run tests
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if npm test --if-present; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Verify package contents
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm pack --dry-run > /tmp/pack-output.txt 2>&1
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/pack-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check for required files
          if grep -q "index.js" /tmp/pack-output.txt; then
            echo "âœ… Main entry point (index.js) included" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Main entry point (index.js) not found in package" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Test CLI binary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## CLI Binary Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test that the CLI can be invoked
          if node index.js --help > /tmp/help-output.txt 2>&1; then
            echo "âœ… CLI help command works" >> $GITHUB_STEP_SUMMARY
            
            # Check for expected commands
            if grep -q "validate" /tmp/help-output.txt; then
              echo "âœ… 'validate' command found in help" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "lint" /tmp/help-output.txt; then
              echo "âœ… 'lint' command found in help" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ CLI help command failed" >> $GITHUB_STEP_SUMMARY
            cat /tmp/help-output.txt
            exit 1
          fi
      
      - name: Test dry-run publish
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Dry-Run Publish Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run npm publish dry-run
          if npm publish --dry-run > /tmp/publish-dry-run.txt 2>&1; then
            echo "âœ… Dry-run publish validation passed" >> $GITHUB_STEP_SUMMARY
            
            # Check for any warnings about sensitive files
            if grep -iE "(\.env|\.git|secret|token|password)" /tmp/publish-dry-run.txt; then
              echo "âš ï¸  Warning: Potential sensitive files detected in package" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Dry-run publish validation failed" >> $GITHUB_STEP_SUMMARY
            cat /tmp/publish-dry-run.txt
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Actual npm publishing requires \`NPM_TOKEN\` secret" >> $GITHUB_STEP_SUMMARY

  # Job 4: Test Binary Building
  test-binary-build:
    name: Test Binary Build (macOS)
    runs-on: macos-latest
    if: |
      github.event.inputs.test_scenario == 'full-pipeline-dry-run' ||
      github.event.inputs.test_scenario == 'npm-package-only'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tools/ripp-cli/package-lock.json
      
      - name: Install dependencies
        working-directory: tools/ripp-cli
        run: npm ci
      
      - name: Install pkg
        run: npm install -g @yao-pkg/pkg
      
      - name: Build test binary (ARM64)
        working-directory: tools/ripp-cli
        run: |
          echo "# ðŸ§ª Binary Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          mkdir -p ../../build/binaries
          
          npx @yao-pkg/pkg . \
            --targets node20-macos-arm64 \
            --output ../../build/binaries/ripp-darwin-arm64
          
          if [ -f "../../build/binaries/ripp-darwin-arm64" ]; then
            FILE_SIZE=$(du -h ../../build/binaries/ripp-darwin-arm64 | cut -f1)
            echo "âœ… ARM64 binary built successfully (Size: $FILE_SIZE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ARM64 binary build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Test binary execution
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Binary Execution Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if ./build/binaries/ripp-darwin-arm64 --help > /tmp/binary-help.txt 2>&1; then
            echo "âœ… Binary executes successfully" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "validate" /tmp/binary-help.txt; then
              echo "âœ… Binary contains expected commands" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Binary execution failed" >> $GITHUB_STEP_SUMMARY
            cat /tmp/binary-help.txt
            exit 1
          fi
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: test-binary-arm64
          path: build/binaries/ripp-darwin-arm64
          retention-days: 7

  # Job 5: Version Consistency Check
  version-consistency:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_scenario == 'full-pipeline-dry-run' ||
      github.event.inputs.test_scenario == 'version-consistency-check'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Check version consistency
        run: |
          echo "# ðŸ§ª Version Consistency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get versions from release-please manifest
          VSCODE_MANIFEST_VERSION=$(jq -r '."tools/vscode-extension"' .release-please-manifest.json)
          CLI_MANIFEST_VERSION=$(jq -r '."tools/ripp-cli"' .release-please-manifest.json)
          
          # Get versions from package.json files
          VSCODE_PACKAGE_VERSION=$(node -p "require('./tools/vscode-extension/package.json').version")
          CLI_PACKAGE_VERSION=$(node -p "require('./tools/ripp-cli/package.json').version")
          
          echo "## VS Code Extension" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest version: \`$VSCODE_MANIFEST_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- package.json version: \`$VSCODE_PACKAGE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VSCODE_MANIFEST_VERSION" = "$VSCODE_PACKAGE_VERSION" ]; then
            echo "âœ… VS Code extension versions match" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ VS Code extension versions don't match" >> $GITHUB_STEP_SUMMARY
            VSCODE_MISMATCH=true
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ripp-cli Package" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest version: \`$CLI_MANIFEST_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- package.json version: \`$CLI_PACKAGE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CLI_MANIFEST_VERSION" = "$CLI_PACKAGE_VERSION" ]; then
            echo "âœ… ripp-cli versions match" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ripp-cli versions don't match" >> $GITHUB_STEP_SUMMARY
            CLI_MISMATCH=true
          fi
          
          # Check package-lock.json versions
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Package Lock Versions" >> $GITHUB_STEP_SUMMARY
          
          VSCODE_LOCK_VERSION=$(node -p "require('./tools/vscode-extension/package-lock.json').version" 2>/dev/null || echo "N/A")
          if [ "$VSCODE_LOCK_VERSION" != "N/A" ]; then
            echo "- VS Code extension package-lock.json: \`$VSCODE_LOCK_VERSION\`" >> $GITHUB_STEP_SUMMARY
            if [ "$VSCODE_LOCK_VERSION" = "$VSCODE_PACKAGE_VERSION" ]; then
              echo "âœ… VS Code extension package-lock.json matches" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸  VS Code extension package-lock.json doesn't match" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Exit with error if any mismatches
          if [ "$VSCODE_MISMATCH" = true ] || [ "$CLI_MISMATCH" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Version consistency check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All versions are consistent" >> $GITHUB_STEP_SUMMARY

  # Job 6: Test Workflow Integration
  test-workflow-integration:
    name: Test Workflow Integration
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scenario == 'full-pipeline-dry-run'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Check workflow files exist
        run: |
          echo "# ðŸ§ª Workflow Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          WORKFLOWS=(
            "release-please.yml"
            "vscode-extension-build.yml"
            "vscode-extension-publish.yml"
            "npm-publish.yml"
            "build-binaries.yml"
          )
          
          for workflow in "${WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              echo "âœ… $workflow exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $workflow not found" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: Verify workflow triggers
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Trigger Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check release-please triggers on main
          if grep -q "branches:" .github/workflows/release-please.yml && grep -q "- main" .github/workflows/release-please.yml; then
            echo "âœ… release-please triggers on main branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  release-please may not trigger on main branch" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check VSIX build triggers on tags
          if grep -q "tags:" .github/workflows/vscode-extension-build.yml; then
            echo "âœ… VSIX build triggers on tags" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  VSIX build may not trigger on tags" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check NPM publish triggers on release
          if grep -q "release:" .github/workflows/npm-publish.yml; then
            echo "âœ… NPM publish triggers on release events" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  NPM publish may not trigger on release events" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check binary build triggers on release
          if grep -q "release:" .github/workflows/build-binaries.yml; then
            echo "âœ… Binary build triggers on release events" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Binary build may not trigger on release events" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check for required secrets
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Required Secrets Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Note:** This test cannot verify actual secret values, only documentation references." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for secret references in workflows
          if grep -q "RELEASE_PAT" .github/workflows/release-please.yml; then
            echo "âœ… RELEASE_PAT referenced in release-please.yml" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  RELEASE_PAT not found in release-please.yml" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "NPM_TOKEN" .github/workflows/npm-publish.yml; then
            echo "âœ… NPM_TOKEN referenced in npm-publish.yml" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  NPM_TOKEN not found in npm-publish.yml" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "VSCE_PAT" .github/workflows/vscode-extension-publish.yml; then
            echo "âœ… VSCE_PAT referenced in vscode-extension-publish.yml" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  VSCE_PAT not found in vscode-extension-publish.yml" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check auto-publish safety
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Auto-Publish Safety Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if workflows have ENABLE_AUTO_PUBLISH checks
          if grep -q "ENABLE_AUTO_PUBLISH" .github/workflows/npm-publish.yml; then
            echo "âœ… NPM publish has ENABLE_AUTO_PUBLISH safety check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  NPM publish may not have auto-publish safety check" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "ENABLE_AUTO_PUBLISH" .github/workflows/vscode-extension-publish.yml; then
            echo "âœ… VS Code publish has ENABLE_AUTO_PUBLISH safety check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  VS Code publish may not have auto-publish safety check" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "ENABLE_AUTO_PUBLISH" .github/workflows/build-binaries.yml; then
            echo "âœ… Binary build has ENABLE_AUTO_PUBLISH safety check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Binary build may not have auto-publish safety check" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 7: Generate Final Test Report
  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: 
      - test-release-please
      - test-vsix-build
      - test-npm-package
      - test-binary-build
      - version-consistency
      - test-workflow-integration
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Generate final report
        run: |
          echo "# ðŸ“Š Test Automation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Scenario:** \`${{ github.event.inputs.test_scenario }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target Package:** \`${{ github.event.inputs.target_package }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job statuses
          RELEASE_PLEASE_STATUS="${{ needs.test-release-please.result }}"
          VSIX_BUILD_STATUS="${{ needs.test-vsix-build.result }}"
          NPM_PACKAGE_STATUS="${{ needs.test-npm-package.result }}"
          BINARY_BUILD_STATUS="${{ needs.test-binary-build.result }}"
          VERSION_CHECK_STATUS="${{ needs.version-consistency.result }}"
          WORKFLOW_INTEGRATION_STATUS="${{ needs.test-workflow-integration.result }}"
          
          # Function to display status
          display_status() {
            case $1 in
              success) echo "âœ… Passed" ;;
              failure) echo "âŒ Failed" ;;
              skipped) echo "â­ï¸  Skipped" ;;
              *) echo "âš ï¸  $1" ;;
            esac
          }
          
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release-Please Configuration | $(display_status $RELEASE_PLEASE_STATUS) |" >> $GITHUB_STEP_SUMMARY
          echo "| VSIX Build | $(display_status $VSIX_BUILD_STATUS) |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Package Build | $(display_status $NPM_PACKAGE_STATUS) |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary Build | $(display_status $BINARY_BUILD_STATUS) |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Consistency | $(display_status $VERSION_CHECK_STATUS) |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Integration | $(display_status $WORKFLOW_INTEGRATION_STATUS) |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if all required tests passed
          ALL_PASSED=true
          if [ "$RELEASE_PLEASE_STATUS" = "failure" ] || [ "$VSIX_BUILD_STATUS" = "failure" ] || \
             [ "$NPM_PACKAGE_STATUS" = "failure" ] || [ "$BINARY_BUILD_STATUS" = "failure" ] || \
             [ "$VERSION_CHECK_STATUS" = "failure" ] || [ "$WORKFLOW_INTEGRATION_STATUS" = "failure" ]; then
            ALL_PASSED=false
          fi
          
          if [ "$ALL_PASSED" = true ]; then
            echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The release automation pipeline is working correctly." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review detailed logs for each test job" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any failing tests" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify that secrets (\`RELEASE_PAT\`, \`NPM_TOKEN\`, \`VSCE_PAT\`) are properly configured" >> $GITHUB_STEP_SUMMARY
          echo "4. Set \`ENABLE_AUTO_PUBLISH\` repository variable to \`true\` when ready for production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Safety Note:** This workflow runs in dry-run mode and does not publish anything to production." >> $GITHUB_STEP_SUMMARY
