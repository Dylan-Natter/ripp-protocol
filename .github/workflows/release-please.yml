name: Release Please

# This workflow implements PR-based auto-versioning for multiple packages in the monorepo.
# It uses conventional commits to determine version bumps and creates/updates
# a Release PR automatically. This approach respects branch protection rules
# because version changes happen through PRs, not direct pushes to main.
#
# Packages managed:
# - tools/vscode-extension: VS Code extension (tag format: vX.Y.Z)
# - tools/ripp-cli: NPM CLI package (tag format: ripp-cli-vX.Y.Z)
#
# How it works:
# 1. On every push to main, release-please analyzes commits since last release
# 2. Based on conventional commits (feat/fix/BREAKING CHANGE), it determines the next version
# 3. It creates or updates a "Release PR" with version bumps and CHANGELOG updates
# 4. When the Release PR is merged, it creates GitHub Releases and tags
# 5. Tags trigger downstream workflows (VSIX build, NPM publish)
#
# Why PR-based versioning?
# - Respects branch protection (no direct pushes from CI)
# - Version changes are reviewable before merge
# - Prevents version conflicts and race conditions
# - Immutable releases once published
# - Clear audit trail of what goes into each version

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Create or Update Release PRs
    runs-on: ubuntu-latest
    
    # Only run on main branch pushes (not on PR merges from release-please itself)
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          # Use the config file for monorepo support
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          
          # Token with permissions to create PRs and tags
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Output release information
        if: steps.release.outputs.releases_created
        run: |
          echo "# Releases Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Output information about created releases
          # The releases_created output contains information about all packages that were released
          RELEASES='${{ steps.release.outputs.releases_created }}'
          if [ -n "$RELEASES" ]; then
            echo "Releases have been created. Check the release-please action outputs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Downstream workflows will now run for each package." >> $GITHUB_STEP_SUMMARY
      
      - name: Output PR information
        if: steps.release.outputs.pr
        env:
          PR_NUMBER: ${{ steps.release.outputs.pr }}
        run: |
          echo "# Release PR Updated ðŸ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review and merge the Release PR to publish new versions." >> $GITHUB_STEP_SUMMARY
