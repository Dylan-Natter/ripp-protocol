name: Publish to VS Code Marketplace

# This workflow publishes the VS Code extension to the Microsoft Marketplace.
# It can be triggered manually or automatically when a GitHub Release is published.
#
# Prerequisites:
# - A Personal Access Token (PAT) with Marketplace publishing rights must be configured as VSCE_PAT secret
#
# To set up the PAT:
# 1. Go to https://dev.azure.com/{your-org}/_usersSettings/tokens
# 2. Create a new PAT with "Marketplace (Publish)" scope
# 3. Add it as a repository secret named VSCE_PAT
#
# Manual Usage:
# - Set publish=false to only build and upload VSIX artifact (safe testing)
# - Set publish=true to actually publish to the Marketplace
# - Set prerelease=true to mark the release as a pre-release version

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to publish (e.g., v0.2.1). Leave empty to use current HEAD.'
        required: false
        type: string
      publish:
        description: 'Publish to Marketplace (false = build only, upload artifact)'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Mark as pre-release version'
        required: false
        type: boolean
        default: false

# Prevent concurrent publishes to the same ref
concurrency:
  group: publish-vscode-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  publish:
    name: Build and Publish Extension
    runs-on: ubuntu-latest
    outputs:
      extension_id: ${{ steps.metadata.outputs.extension_id }}
      version: ${{ steps.metadata.outputs.version }}
      published: ${{ steps.publish_status.outputs.published }}
      vsix_file: ${{ steps.vsix_name.outputs.filename }}
    
    # Only run if:
    # - Auto-publish is enabled (for release events) AND tag is for VS Code extension (vX.Y.Z not ripp-cli-vX.Y.Z), OR
    # - Manual workflow_dispatch
    if: |
      (github.event_name == 'release' && !startsWith(github.event.release.tag_name, 'ripp-cli-v') && vars.ENABLE_AUTO_PUBLISH == 'true') ||
      github.event_name == 'workflow_dispatch'
    
    defaults:
      run:
        working-directory: tools/vscode-extension
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.tag_name || github.event.release.tag_name || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tools/vscode-extension/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get extension metadata
        id: metadata
        run: |
          VERSION=$(node -p "require('./package.json').version")
          PUBLISHER=$(node -p "require('./package.json').publisher")
          NAME=$(node -p "require('./package.json').name")
          EXTENSION_ID="${PUBLISHER}.${NAME}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "publisher=$PUBLISHER" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "extension_id=$EXTENSION_ID" >> $GITHUB_OUTPUT
          
          echo "Extension: $EXTENSION_ID v$VERSION"
      
      - name: Run lint
        run: npm run lint
      
      # Uncomment when tests are available:
      # - name: Run tests
      #   run: npm test
      
      - name: Compile TypeScript
        run: npm run compile
      
      - name: Package extension
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ github.event.inputs.prerelease || 'false' }}" == "true" ]; then
            PRERELEASE_FLAG="--pre-release"
          fi
          npx @vscode/vsce package --no-dependencies $PRERELEASE_FLAG
      
      - name: Dry-run validation of VSIX package
        run: |
          echo "# ðŸ§ª Dry Run Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get the VSIX file
          VSIX_FILE=$(ls *.vsix)
          echo "Validating VSIX package: $VSIX_FILE" >> $GITHUB_STEP_SUMMARY
          
          # Check package size (warn if > 50MB)
          SIZE_MB=$(du -m "$VSIX_FILE" | cut -f1)
          echo "**Package size:** ${SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          
          if [ $SIZE_MB -gt 50 ]; then
            echo "âš ï¸ Warning: Package size exceeds 50MB" >> $GITHUB_STEP_SUMMARY
          fi
          
          # List package contents
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package contents:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          unzip -l "$VSIX_FILE" | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check for sensitive files
          if unzip -l "$VSIX_FILE" | grep -iE "(\.env|\.git|secret|token|password|\.npmrc)"; then
            echo "::warning::Potential sensitive files detected in package"
            echo "âš ï¸ Warning: Potential sensitive files detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verify manifest exists
          if unzip -l "$VSIX_FILE" | grep -q "extension/package.json"; then
            echo "âœ… Extension manifest verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::Extension manifest not found in package"
            echo "âŒ Extension manifest missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dry run validation passed" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload VSIX artifact
        id: vsix_info
        uses: actions/upload-artifact@v6
        with:
          name: vscode-extension-${{ steps.metadata.outputs.version }}
          path: tools/vscode-extension/*.vsix
          retention-days: 30
          if-no-files-found: error
      
      - name: Capture VSIX filename
        id: vsix_name
        run: |
          VSIX_FILE=$(ls *.vsix)
          echo "filename=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "VSIX file: $VSIX_FILE"
      
      - name: Publish to Marketplace
        id: publish_status
        # Only publish if:
        # - This is a release event (auto-publish), OR
        # - Manual workflow with publish=true
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
        run: |
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "::error::VSCE_PAT secret is not configured. Cannot publish."
            exit 1
          fi
          
          PRERELEASE_FLAG=""
          if [ "${{ github.event.inputs.prerelease || 'false' }}" == "true" ]; then
            PRERELEASE_FLAG="--pre-release"
          fi
          
          npx @vscode/vsce publish --packagePath *.vsix $PRERELEASE_FLAG
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      
      - name: Job summary
        if: always()
        run: |
          PUBLISH_STATUS="${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true') }}"
          PRERELEASE="${{ github.event.inputs.prerelease || 'false' }}"
          
          if [ "$PUBLISH_STATUS" == "true" ]; then
            echo "# âœ… Successfully Published to Marketplace! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ðŸ“¦ Build Complete (Not Published)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Extension ID:** \`${{ steps.metadata.outputs.extension_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Publisher:** \`${{ steps.metadata.outputs.publisher }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.metadata.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PRERELEASE" == "true" ]; then
            echo "**Pre-release:** Yes" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PUBLISH_STATUS" == "true" ]; then
            echo "**Marketplace URL:** https://marketplace.visualstudio.com/items?itemName=${{ steps.metadata.outputs.extension_id }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The extension should be available in VS Code within a few minutes." >> $GITHUB_STEP_SUMMARY
          else
            echo "**VSIX Artifact:** Available for download in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To publish this build, re-run the workflow with \`publish=true\`" >> $GITHUB_STEP_SUMMARY
          fi
  
  smoke-tests:
    name: Post-Publish Smoke Tests
    runs-on: ubuntu-latest
    needs: publish
    # Only run smoke tests if extension was actually published
    if: needs.publish.outputs.published == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Download VSIX artifact
        uses: actions/download-artifact@v7
        with:
          name: vscode-extension-${{ needs.publish.outputs.version }}
          path: ./vsix
      
      - name: Verify VSIX structure
        run: |
          echo "# ðŸ§ª Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VSIX_FILE=$(ls ./vsix/*.vsix)
          echo "**Testing VSIX:** $VSIX_FILE" >> $GITHUB_STEP_SUMMARY
          
          # Verify VSIX can be unzipped
          if unzip -t "$VSIX_FILE" > /tmp/vsix-test.txt 2>&1; then
            echo "âœ… VSIX structure is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::VSIX file is corrupted or invalid"
            echo "âŒ VSIX structure is invalid" >> $GITHUB_STEP_SUMMARY
            cat /tmp/vsix-test.txt
            exit 1
          fi
          
          # Verify extension manifest exists and is valid
          if unzip -p "$VSIX_FILE" extension/package.json > /tmp/package.json 2>&1; then
            echo "âœ… Extension manifest extracted successfully" >> $GITHUB_STEP_SUMMARY
            
            # Verify basic package.json structure
            if grep -q "\"name\"" /tmp/package.json && grep -q "\"version\"" /tmp/package.json; then
              echo "âœ… Extension manifest contains required fields" >> $GITHUB_STEP_SUMMARY
            else
              echo "::error::Extension manifest is missing required fields"
              echo "âŒ Extension manifest is incomplete" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "::error::Could not extract extension manifest"
            echo "âŒ Extension manifest not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Verify extension size
        run: |
          VSIX_FILE=$(ls ./vsix/*.vsix)
          SIZE_MB=$(du -m "$VSIX_FILE" | cut -f1)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Package Size Check" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          
          if [ $SIZE_MB -gt 100 ]; then
            echo "::warning::Extension size exceeds 100MB - this may cause installation issues"
            echo "âš ï¸ Warning: Size exceeds 100MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Size is within acceptable limits" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Wait for Marketplace propagation
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Marketplace Availability Check" >> $GITHUB_STEP_SUMMARY
          echo "â³ Waiting 60 seconds for Marketplace to propagate..." >> $GITHUB_STEP_SUMMARY
          sleep 60
      
      - name: Check Marketplace listing
        run: |
          EXTENSION_ID="${{ needs.publish.outputs.extension_id }}"
          MARKETPLACE_URL="https://marketplace.visualstudio.com/items?itemName=$EXTENSION_ID"
          
          # Try to fetch the marketplace page
          if curl -s -o /dev/null -w "%{http_code}" "$MARKETPLACE_URL" | grep -q "200"; then
            echo "âœ… Extension is available on Marketplace" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** $MARKETPLACE_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Extension may not be immediately available (can take a few minutes)" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Extension not yet visible on Marketplace"
          fi
      
      - name: Smoke tests summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… All Smoke Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The published extension is working correctly and ready for installation." >> $GITHUB_STEP_SUMMARY
